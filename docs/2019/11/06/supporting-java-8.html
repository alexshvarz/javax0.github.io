<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Supporting Java 8 | Java Deep, mostly Java</title>
<meta name="generator" content="Jekyll v4.3.3" />
<meta property="og:title" content="Supporting Java 8" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Although Java has version 13 released as for now, there are a lot of production installations running with Java 8. As a professional, I develop Java 8 code many times even these days and I have to be happy that this is not Java 6. On the other hand as an open-source developer, I have my liberty to develop my Java code using Java 11, 12 or even 13 if that pleases me. And it does." />
<meta property="og:description" content="Although Java has version 13 released as for now, there are a lot of production installations running with Java 8. As a professional, I develop Java 8 code many times even these days and I have to be happy that this is not Java 6. On the other hand as an open-source developer, I have my liberty to develop my Java code using Java 11, 12 or even 13 if that pleases me. And it does." />
<link rel="canonical" href="http://localhost:4000/2019/11/06/supporting-java-8.html" />
<meta property="og:url" content="http://localhost:4000/2019/11/06/supporting-java-8.html" />
<meta property="og:site_name" content="Java Deep, mostly Java" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2019-11-06T00:00:00+01:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Supporting Java 8" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2019-11-06T00:00:00+01:00","datePublished":"2019-11-06T00:00:00+01:00","description":"Although Java has version 13 released as for now, there are a lot of production installations running with Java 8. As a professional, I develop Java 8 code many times even these days and I have to be happy that this is not Java 6. On the other hand as an open-source developer, I have my liberty to develop my Java code using Java 11, 12 or even 13 if that pleases me. And it does.","headline":"Supporting Java 8","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:4000/2019/11/06/supporting-java-8.html"},"url":"http://localhost:4000/2019/11/06/supporting-java-8.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="http://localhost:4000/feed.xml" title="Java Deep, mostly Java" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Java Deep, mostly Java</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Java Deep</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Supporting Java 8</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2019-11-06T00:00:00+01:00" itemprop="datePublished">Nov 6, 2019
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div class="paragraph">
<p>Although Java has version 13 released as for now, there are a lot of production installations running with Java 8. As a professional, I develop Java 8 code many times even these days and I have to be happy that this is not Java 6. On the other hand as an open-source developer, I have my liberty to develop my Java code using Java 11, 12 or even 13 if that pleases me. And it does.</p>
</div>
<div class="paragraph">
<p>On the other hand, though, I want my code to be used. Developing a tool like License3j or Java::Geci, which are kind of libraries releasing Java 11 compatible byte code cuts off all the Java 8 based applications that may use these libraries.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>I want the libraries to be available from Java 8.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>One solution is to keep two branches parallel in the Git repo and have a Java 11+ and a Java 8 version of the code. This is what I have done for Java::Geci 1.2.0 release. It is cumbersome, error-prone and it is a lot of work. I had this code only because my son, who is also a Java developer starting his career volunteered.</p>
</div>
<div class="paragraph">
<p>(No, I did not pressure him. He speaks and writes better English than I do, and he regularly reviews these articles fixing my broken languages. If he has different opinion about the pressure, he is free to insert here any note till the closing parenthesis, I will not delete or modify that. NOTE: )</p>
</div>
<div class="paragraph">
<p>Anything above between the <code>NOTE:</code> and <code>)</code> is his opinion.</p>
</div>
<div class="paragraph">
<p>The other possibility is to use <a href="https://github.com/bsideup/jabel">Jabel</a>.</p>
</div>
<div class="paragraph">
<p>In this article, I will write about how I used Jabel in the project Java::Geci. The documentation of Jabel is short but still complete and it really works like that for simpler projects. For example I really only had to add a few lines to the <code>pom.xml</code> in case of the Licenese3j project. For more complex projects that were developed over a year without thinking about any compromise for Java 8 compatibility, it is a bit more complex.</p>
</div>
<div class="sect1">
<h2 id="1-about-jabel">1. About Jabel</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Jabel is an open-source project available from <a href="https://github.com/bsideup/jabel" class="bare">https://github.com/bsideup/jabel</a>. If you have a Java 9+ project source you can configure Jabel to be part of the compilation process. It is an annotation processor that hooks into the compilation process and kind of tricks the compiler to accept the Java 9+ features as they were available for Java 8. The compiler will work and generate Java 8, Jabel does not interfere with the byte code generation, so this is as genuine as it can be out of the Java compiler fresh and warm. It only instructs the compiler not to freak out on Java 9+ features when compiling the code.</p>
</div>
<div class="paragraph">
<p>The way it works and why it can work is well written on the project&#8217;s GitHub page. What I wrote above may not even be precise.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="2-backport-issues">2. Backport issues</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When creating Java code using Java 9+ features targeting a Java 8 JVM it is not only the byte code version that we should care about. The code executed using the Java 8 JVM will use the Java 8 version of the JDK and in case we happen to use some classes or methods that are not available there then the code will not run. Therefore we have two tasks:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Configure the build to use Jabel to produce Java 8 byte-code</p>
</li>
<li>
<p>eliminate the JDK calls that are not available in Java 8.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="2-1-configure-build">2.1. Configure Build</h3>
<div class="paragraph">
<p>I will not describe here how to configure Jabel to be part of the build using Maven. It is documented on the site and is straightforward.</p>
</div>
<div class="paragraph">
<p>In the case of Java::Geci I wanted something different. I wanted a Maven project that can be used to create Java 8 as well as Java 11 targets. I wanted this because I wanted Java::Geci to support JPMS just as before and also to create state-of-the-art byte code (class nesting instead of bridge methods for example) for those projects that run on Java 11 or later.</p>
</div>
<div class="paragraph">
<p>As the first step, I created a profile named <code>JVM8</code>. Jabel is only configured to run only when this profile is active.</p>
</div>
<div class="paragraph">
<p>This profile also sets the release as</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">&lt;release&gt;8&lt;/release&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>so the very first time the compiler was freaking out when it saw the <code>module-info.java</code> files. Fortunately, I can exclude files in the POM file in the <code>JVM8</code> profile. I also excluded <code>javax0/geci/log/LoggerJDK9.java</code> and I will talk about that later.</p>
</div>
<div class="paragraph">
<p>I also tried to use Maven to automatically configure the version number to have the <code>-JVM8</code> postfix if it runs with the <code>JVM8</code> profile but it was not possible. Maven is a versatile tool and can do many things and in case of a simpler project doing that should be the approach. In the case of Java::Geci I could not do that because Java:Geci is a multi-module project.</p>
</div>
<div class="paragraph">
<p>Multi-module projects refer to each other. At least the child module reference the parent module. The version of the child module may be different from the version of the parent module. It is kind of logical since their evolution and development are not necessarily tied together. However, usually, it is. In projects, like Java::Geci that has seven child modules and each child module has the very same version number as the parent the child modules can inherit all the parameters, dependencies, compiler options and so on, from the parent but the version. It cannot inherit the version because it does not know which parent version to inherit it from. It is a catch 22.</p>
</div>
<div class="paragraph">
<p>The Java::Geci development goes around this problem using the Jamal preprocessor maintaining the eight <code>pom.xml</code> files. Whenever there is a change in the build configuration it has to be edited in one of the <code>pom.xml.jam</code> files or in one of the included <code>*.jim</code> files and then the command line <code>mvn -f genpom.xml clean</code> will regenerate all the new <code>pom.xml</code> files. This also saves some repetitive code as the preprocessed Jamal files are not so verbose as the corresponding XML files. The price for this is that the macros used have to be maintained.</p>
</div>
<div class="paragraph">
<p>Java::Geci has a <code>version.jim</code> file that contains the version of the project as a macro. When targeting a Java 8 release then the version in this file has to be changed to <code>x.y.z-JVM8</code> and the command <code>mvn -f genpom.xml clean</code> has to be executed. Unfortunately, this is a manual step that I may forget. I may also forget to remove the <code>-JVM8</code> postfix after the Java 8 target was created.</p>
</div>
<div class="paragraph">
<p>To mitigate the risk of this human error I developed a unit test that checks the version number is coherent with the compilation profile. It identified the compilation profile reading the <code>/javax0/geci/compilation.properties</code> file. This is a resource file in the project filtered by Maven and contains</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-text" data-lang="text">projectVersion=${project.version}
profile=${profile}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the test runs the properties are replaced by the actual values as defined in the project. <code>project.version</code> is the project version. The property <code>profile</code> is defined in the two profiles (default and <code>JVM8</code>) to be the name of the profile.</p>
</div>
<div class="paragraph">
<p>If the version and the profile do not match the test fails. Following the philosophy of Java::Geci, the test does not just order the programmer to fix the "bug" when the test itself can also fix the bug. It modifies the <code>version.jim</code> file so that it contains the correct version. It does not, however, run the pom file generating Jamal macros.</p>
</div>
<div class="paragraph">
<p>As a result of this I will get release files with version <code>x.y.z</code> and also <code>x.y.z-JVM8</code> after the second build with some manual editing work.</p>
</div>
</div>
<div class="sect2">
<h3 id="2-2-eliminate-java-8-jdk-calls">2.2. Eliminate Java 8+ JDK calls</h3>
<div class="sect3">
<h4 id="2-2-1-simple-calls">2.2.1. Simple calls</h4>
<div class="paragraph">
<p>This is a simple task at first sight. You must not use methods that are not in Java 8 JDK. We could do anything using Java 8 so it is a task that certainly possible.</p>
</div>
<div class="paragraph">
<p>For example every</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">" ".repeat(tab)</code></pre>
</div>
</div>
<div class="paragraph">
<p>has to be eliminated. To do that I created a class <code>JVM8Tools</code> that contain static methods. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">public static String space(int n){
    final StringBuilder sb = new StringBuilder(/*20 spaces*/"                    ");
    while( sb.length() &lt; n){
        sb.append(sb);
    }
    return sb.substring(0,n).toString();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>is defined there and using this method I can write</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">space(tab)</code></pre>
</div>
</div>
<div class="paragraph">
<p>instead of the invocation of <code>String::repeat</code> method. This part was easy.</p>
</div>
</div>
<div class="sect3">
<h4 id="2-2-2-mimicking-getnesthost">2.2.2. Mimicking <code>getNestHost</code></h4>
<div class="paragraph">
<p>What was a bit more difficult is to implement the <code>getNestHost()</code> method. There is no such thing in Java 8, but the selector expressions included in the Tools module of Java::Geci lets you use expressions, like</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-java" data-lang="java">Selector.compile("nestHost -&gt; (!null &amp;amp; simpleName ~ /^Map/)").match(Map.Entry.class)</code></pre>
</div>
</div>
<div class="paragraph">
<p>to check that the class <code>Entry</code> is declared inside <code>Map</code>, which it trivially is. It makes sense to use this expression even in Java 8 environment someone chooses to do so and I did not want to perform amputation dropping this feature from Java::Geci. It had to be implemented.</p>
</div>
<div class="paragraph">
<p>The implementation checks the actual run-time and in case the method is there in the JDK then it calls that via reflection. In other cases, it mimics the functionality using the name of the class and trying to find the <code>$</code> character that separates the inner and the enclosing class name. This may lead to false results in the extremely rare case when there are multiple instances of the same class structures loaded using different class loaders. I think that a tool, like Java::Geci can live with it, it barely happens while executing unit tests.</p>
</div>
<div class="paragraph">
<p>There is also a speed drawback calling the method <code>Class#getNestHost</code> reflectively. I decide to fix it if there will be real demand.</p>
</div>
</div>
<div class="sect3">
<h4 id="2-2-3-logging-support">2.2.3. Logging support</h4>
<div class="paragraph">
<p>The last issue was logging. Java 9 introduced a logging facade that is highly recommended to be used by the libraries. Logging is a long-standing problem in the Java environment. The problem is not that there is not any. Quite the opposite. There are too many. There is Apache Commons Logging, Log4j, Logback, the JDK built-in java util logging. A standalone application can select the logging framework it uses, but in case a library uses a different one then it is difficult if not impossible to funnel the different log messages into the same stream.</p>
</div>
<div class="paragraph">
<p>Java 9 thus introduced a new facade that a library can use to send out its logs and the applications can channel the output through the facade to whatever logging framework they want. Java::Geci uses this facade and provides logging API for the generators through it. In case the JVM8 environment this is not possible. In that case Java::Geci channels the log messages into the standard Java logger. To do that there is a new interface <code>LoggerJDK</code> implemented by two classes <code>LoggerJVM8</code> and <code>LoggerJDK9</code>. The source code for the latter is excluded from the compilation in case the target is Java 8.</p>
</div>
<div class="paragraph">
<p>The actual logger tries to get the <code>javax0.geci.log.LoggerJDK9#factory</code> via reflection. If it is there, then it is possible to use the Java 9 logging. If it is not there then the logger falls back to with the factory to <code>javax0.geci.log.LoggerJVM8#factory</code>. That way only the logger factory is called via reflection, which happens only once for every logger. Logging itself is streamlined and uses the target logging without any reflection, thus without speed impediment.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3-takeaway">3. Takeaway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It is possible to support Java 8 in most of the library project without unacceptable compromise. We can create two different binaries from the same source that support the two different versions in a way that the version supporting Java 9 and later does not "suffer" from the old byte code. There are certain compromises. You must avoid calling Java 9+ API and in case there is an absolute need, you have top provide a fall-back and you can provide a reflection-based run-time detection solution.</p>
</div>
</div>
</div>


<!-- Disqus comments section goes here (if comments are enabled) -->

<hr/>
<h1>Comments</h1>
<p>Please leave your comments using Disqus, or just press one of the happy faces.
If for any reason you do not want to leave a comment here, <a href="https://github.com/javax0/javax0.github.io/issues">you can still create a Github ticket</a>.</p>
<div class="comments">
    <div id="disqus_thread"></div>

    <script type="text/javascript">

        /* * * STOP! * * */
        /* You shouldn't need to edit ANYTHING below to get this working! */
        /* Instead, edit the key `disqus.shortname` in _config.yml */

        var disqus_config = function (){
            this.page.url = 'http://localhost:4000/2019/11/06/supporting-java-8.html';
            this.page.identifier = '/2019/11/06/supporting-java-8.html';
        };

        (function() {
            var d = document, s = d.createElement('script');
            s.type = 'text/javascript'; s.async = true;
            s.src = 'https://javax0.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();

    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>




  </div><a class="u-url" href="/2019/11/06/supporting-java-8.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Java Deep, mostly Java</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Java Deep, mostly Java</li><li><a class="u-email" href="mailto:peter@verhas.com">peter@verhas.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/verhas"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">verhas</span></a></li><li><a href="https://www.twitter.com/verhas"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">verhas</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>javax0 is a technical Java oriented blog. Whenever I find something interesting, in the mood and feel the power to publish it, you will get it here. Publications are usually released on Wednesday 15:00am GMT. Earlier posts of the blog were published on Javax0 Wordpress Site at https://javax0.wordpress.com</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
