<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.8.0 -->
<title>Adding Mermaid Diagrams to Markdown Documents | Java Deep, mostly Java</title>
<meta name="generator" content="Jekyll v4.3.1" />
<meta property="og:title" content="Adding Mermaid Diagrams to Markdown Documents" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="javax0 is a technical Java oriented blog. Whenever I find something interesting, in the mood and feel the power to publish it, you will get it here. Publications are usually released on Wednesday 15:00am GMT. Earlier posts of the blog were published on Javax0 Wordpress Site at https://javax0.wordpress.com" />
<meta property="og:description" content="javax0 is a technical Java oriented blog. Whenever I find something interesting, in the mood and feel the power to publish it, you will get it here. Publications are usually released on Wednesday 15:00am GMT. Earlier posts of the blog were published on Javax0 Wordpress Site at https://javax0.wordpress.com" />
<link rel="canonical" href="https://javax0.github.io/2023/06/05/mermaid-in-jamal.html" />
<meta property="og:url" content="https://javax0.github.io/2023/06/05/mermaid-in-jamal.html" />
<meta property="og:site_name" content="Java Deep, mostly Java" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2023-06-05T00:00:00+02:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="Adding Mermaid Diagrams to Markdown Documents" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-06-05T00:00:00+02:00","datePublished":"2023-06-05T00:00:00+02:00","description":"javax0 is a technical Java oriented blog. Whenever I find something interesting, in the mood and feel the power to publish it, you will get it here. Publications are usually released on Wednesday 15:00am GMT. Earlier posts of the blog were published on Javax0 Wordpress Site at https://javax0.wordpress.com","headline":"Adding Mermaid Diagrams to Markdown Documents","mainEntityOfPage":{"@type":"WebPage","@id":"https://javax0.github.io/2023/06/05/mermaid-in-jamal.html"},"url":"https://javax0.github.io/2023/06/05/mermaid-in-jamal.html"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://javax0.github.io/feed.xml" title="Java Deep, mostly Java" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Java Deep, mostly Java</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/about/">About</a><a class="page-link" href="/">Java Deep</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline">Adding Mermaid Diagrams to Markdown Documents</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2023-06-05T00:00:00+02:00" itemprop="datePublished">Jun 5, 2023
      </time></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="images/e8a96c341e35bf3594a44f6a47e198b17c60affc393db847a4e26f7ed05708b5.svg" alt="e8a96c341e35bf3594a44f6a47e198b17c60affc393db847a4e26f7ed05708b5">
</div>
</div>
<div class="paragraph">
<p>Mermaid is a trendy diagramming tool.
A year ago, it was integrated into the Markdown rendering of Github.
(see <a href="https://github.blog/2022-02-14-include-diagrams-markdown-files-mermaid/" class="bare">https://github.blog/2022-02-14-include-diagrams-markdown-files-mermaid/</a>)
It is also integrated into several editors.</p>
</div>
<div class="paragraph">
<p>What can you do, however, if you use a different editor?
What if you want to use your Markdown document in an environment that does not integrate Mermaid yet?
What can you do if the diagram is not Mermaid but PlantUML, Graphviz, or any other diagramming tool?</p>
</div>
<div class="paragraph">
<p>This article will show how you can integrate ANY diagram-as-code tool into your documents.
The technique works for Markdown, Asciidoc, APT, or any other text-based markup language.</p>
</div>
<div class="paragraph">
<p>However, before anything else, here is a demonstration image, which was created the way I will describe in this article.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="https://raw.githubusercontent.com/javax0/javax0.github.io/master/assets/images/e8a96c341e35bf3594a44f6a47e198b17c60affc393db847a4e26f7ed05708b5.svg" alt="e8a96c341e35bf3594a44f6a47e198b17c60affc393db847a4e26f7ed05708b5">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="1-problem-statement">1. Problem Statement</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When documenting some systems, it is often necessary to include diagrams.
Keeping diagrams in separate files has advantages but also disadvantages.
It is easier to keep the consistency of the documentation when the different parts are close together.
The more distanced the two corresponding and related parts are, the more likely that one or the other becomes stale when the other is updated.</p>
</div>
<div class="paragraph">
<p>It is also a good idea if you can parameterize the diagram, and you could avoid copy-pasting diagram parameters from the document, the documented code, or the other way around.</p>
</div>
<div class="paragraph">
<p>To solve these problems, more and more markup languages support selected diagramming tool markups to embed in the text.
You can include Mermaid in Markdown documents if you target GitHub hosting for your document.
You can include PlantUML diagrams in Asciidoc documents.</p>
</div>
<div class="paragraph">
<p>What happens, however, if you want to include Mermaid in Asciidoc?
What if you need PlantUML in Markdown?
How do you solve the issue if you want to host your Markdown elsewhere besides GitHub?</p>
</div>
<div class="paragraph">
<p>You can abandon your ideas, stick to the available tools or wait for a solution.
The latter approach, however, will always remain an issue.
There will always be a new tool you want to use, and you will have to wait for the support of that tool in your favorite markup language.</p>
</div>
<div class="paragraph">
<p>The principal reason for this is an architectural mismatch.</p>
</div>
<div class="sidebarblock">
<div class="content">
<div class="paragraph">
<p>Document markup languages must be responsible only for document structure and content and nothing else.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Embedding a diagramming tool into the markup language must not be implemented in these languages.
It is a separate concern with the document&#8217;s programmability ensuring document consistency automation.</p>
</div>
<div class="paragraph">
<p>The solution is to use a meta markup above the document markup.
This meta markup can be document markup agnostic and support all the diagramming tools you want to use.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="2-ideas-and-approach-to-solve-the-problem">2. Ideas and Approach to Solve the problem</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The basic idea is not new: separation of concerns.
The document markup language should be responsible for the document structure and content.
The diagramming tool should be responsible for the diagramming.
The meta markup should be responsible for the integration.</p>
</div>
<div class="paragraph">
<p>Since the meta markup is language agnostic, it can be used with any existing and future document markup languages.
There is no need to wait for the support of the diagramming tool in the document markup language.
The only question is the integration of the meta markup into the document markup language.</p>
</div>
<div class="paragraph">
<p>The simplest and loosest way to integrate the meta markup is to use a preprocessor.
Processing the meta markup, we read and generate a text file.
The document markup processing tool catches where the meta markup has left off.
It has no idea that a program generates the document markup and is not manually edited.
Strictly speaking, when you edit a document markup, then the editor is the program that generates the file.
Technically, there is no difference.</p>
</div>
<div class="paragraph">
<p>There are other possibilities.
Most document markups support different editors to deliver some form of WYSIWYG editing.
The meta markup preprocessor can be integrated into these editors.
That way, the document markup enriched with the meta markup can seamlessly be edited in the WYSIWYG editor.</p>
</div>
<div class="paragraph">
<p>The proposed meta markup and the implementing tool, Jamal, follow both approaches.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="3-suggested-solution-tools">3. Suggested Solution, Tools</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The suggested solution is to use Jamal as the meta markup.
Jamal is a general-purpose macro processor.
There are other meta markup processing tools, like <a href="https://facelessuser.github.io/pymdown-extensions/">PyMdown</a>.
These tools usually target a specific document markup and a specific purpose.</p>
</div>
<div class="paragraph">
<p>Jamal is a general-purpose, turning complete macro processor with more than 200 macros for different purposes.
These macros make your documents programmable to automate manual document maintenance tasks.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p>The general saying is: if you could give a task to an assistant to do, then you can automate it with Jamal.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Jamal has a PlantUML module.
PlantUML is written in Java, the development language I used to create Jamal.
It makes the integration of PlantUML into Jamal easy, and PlantUML diagrams embedded into the documentation can be converted in the process.
Jamal, however, is not limited to using only tools written in Java.
To demonstrate it, we will use the Mermaid diagramming tool, written in JavaScript and running with node.</p>
</div>
<div class="paragraph">
<p>Since Mermaid is not a Java program, it cannot be executed inside the JVM.
We will create our documentation to execute Mermaid as a separate process.
Other diagramming tools can be integrated similarly if executed on the document processing machine.</p>
</div>
<div class="sect2">
<h3 id="3-1-install-mermaid">3.1. Install Mermaid</h3>
<div class="paragraph">
<p>The first step is to install Mermaid.
The steps are documented on the <a href="https://mermaid.sj.org">Mermaid site</a>.
I will not repeat the steps here because I do not want to create a document that gets outdated.</p>
</div>
<div class="paragraph">
<p>On my machine, the installation creates the  <code>/usr/local/bin/mmdc</code> executable.
This file is a JavaScript script that starts the Mermaid diagramming tool.
While executing from Jamal, I realized the process has a different environment than my login script.
To deal with that, I had to edit the file.
Instead of using the <code>env</code> command to find the node interpreter, I specified the full path to the node executable.
Other installations may be different, and it does not affect the rest of the article.
It is a technical detail.</p>
</div>
</div>
<div class="sect2">
<h3 id="3-2-install-jamal">3.2. Install Jamal</h3>
<div class="paragraph">
<p>We will use Jamal as the meta markup processor.
The installation is detailed in the <a href="https://github.com/verhas/jamal">documentation of Jamal</a>.
You can start it from the command line, as a Maven plugin, using Jbang and many other ways.
I recommend using it as a preprocessor integrated into the IntelliJ Asciidoctor plugin.
It will provide you with WYSIWYG editing of your document in Markdown and Asciidoc enriched with Jamal macros.
Also, the installation is nothing more than executing the command line</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mvn com.javax0.jamal:jamal-maven-plugin:2.1.0:jamalize</pre>
</div>
</div>
<div class="paragraph">
<p>which will download the version 2.1.0 we use in this article by the time pre-release and copy all the needed files into your project&#8217;s <code>.asciidoctor/lib</code> directory.
It will make the macros available for the Asciidoctor plugin.
What needs manual work is configuring IntelliJ to treat all <code>.jam</code> files as Asciidoc files.
That way, the editor will invoke the Asciidoctor plugin and use the Jamal preprocessor.
It is the setup that I also use to write the articles.</p>
</div>
</div>
<div class="sect2">
<h3 id="3-3-create-the-macros-for-mermaid">3.3. Create the macros for Mermaid</h3>
<div class="paragraph">
<p>To have a mermaid document inside the document, we should do three things using macros:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Save the Mermaid text into a file.</p>
</li>
<li>
<p>Execute the Mermaid tool to convert the text into an SVG file.</p>
</li>
<li>
<p>Reference the SVG file as an image in the document.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Later, we will see how to save on Mermaid processing, executing it only when the Mermaid text changes.</p>
</div>
<div class="paragraph">
<p>We will use the <code>io:write</code> macro to save the Mermaid text into a file.
This macro is in a package that is not loaded by default.
We have to load it explicitly.
To do that, we use the <code>maven:load</code> macro.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-jamal" data-lang="jamal">{@maven:load com.javax0.jamal:jamal-io:2.1.0}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
<div class="paragraph">
<p>This macro package has to be configured as safe for the document in the <code>.jamal/settings.properties</code> file as it is documented.
The macros in this package can read and write files and execute commands configured.
To use a macro package like that from an untrusted source is a security risk.
For this reason, every package loaded by the <code>maven:load</code> macro has to be configured as safe.
The configuration specifies the package and the documents where it can be used.</p>
</div>
<div class="paragraph">
<p>At the same time, the io package also needs configuration to be able to execute the <code>mmdc</code> command.
To do that, the configuration file contains a</p>
</div>
<div class="literalblock">
<div class="content">
<pre>mermaid=/usr/local/bin/mmdc</pre>
</div>
</div>
<div class="paragraph">
<p>line assigning a symbolic name to the actual command.
The <code>io:exec</code> macro will use this symbolic name to find the command to execute.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the macro package is loaded, we can use the <code>io:write</code> macro as in the following sample:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-jamal" data-lang="jamal">{#define CHART=flowchart TD
A[Christmas] --&gt;|Get money| B(Go shopping)
B --&gt; C{Let me think}
C --&gt;|One| D[Laptop]
C --&gt;|Two| E[iPhone]
C --&gt;|Three| F[fa:fa-car Care]
}
{#io:write (output="aaa.mmd") {CHART}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the file is created, we can execute the Mermaid tool to convert it into an SVG file, as the following</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-jamal" data-lang="jamal">{#io:exec command="""mermaid
-i
aaa.mmd
-o
aaa.svg
""" cwd="." error="convert.err.txt" output="convert.out.txt"
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By that, we have the file.
Whenever the Mermaid text changes, the SVG file will be recreated.</p>
</div>
<div class="paragraph">
<p>As a matter of fact, whenever the document changes, the SVG file will be recreated.
It wastes resources when the diagram remains the same and the processing runs interactively.
To help with that, we can use the <code>hashCode</code> macro.</p>
</div>
<div class="paragraph">
<p>The macro <code>hashCode</code> calculates the hash code of the text.
We will use the hash code to name the file.
Whenever the diagram changes, the file&#8217;s name changes.
Also, if the file exists, it should contain the diagram for the current text.</p>
</div>
<div class="paragraph">
<p>To check that the file exists, we include it in the document.
Because we do not want the SVG text in the document, we surround the <code>include</code> with the <code>block</code> macro.
If the file does not exist, then an error will occur.
The macro <code>try</code> will handle this error, and the execution will continue.
However, the macro <code>CREATE</code> will be set to <code>true</code> in this case.
If there is no error, when the file already exists, the macro <code>CREATE</code> will be set to <code>false</code>.</p>
</div>
<div class="paragraph">
<p>The <code>if</code> macro will check the value of the macro <code>CREATE</code>.
If it is <code>true</code>, it will execute the <code>io:write</code> and <code>io:exec</code> macros to create the file.
If it is <code>false,</code> then it will do nothing.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-jamal" data-lang="jamal">{#define KEY={#hashCode {CHART}}}{@define CREATE=true}
{@try {#block{#include images/{KEY}.svg}}{@define CREATE=false}}
{#if `//`{CREATE}//
{#io:write (mkdir output="images/aaa.mmd") {CHART}}
{#io:exec command="""mermaid
-i
images/aaa.mmd
-o
images/{KEY}.svg
""" cwd="." error="convert.err.txt" output="convert.out.txt"
}//}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For more details using these macros, please refer to the documentation.
If you intend to use multiple diagrams, you may want to create a macro that does all the steps above.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="4-summary-and-takeaway">4. Summary and Takeaway</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This article discussed integrating Mermaid diagrams into your Asciidoc, Markdown, or any other markup document.
We selected Mermaid for two reasons.
First, usually, this is the tool people ask for.
Second, this is an excellent example of a non-Java tool that can be integrated into document processing.
The described way can be applied to any external tool capable of running as a process.</p>
</div>
<div class="paragraph">
<p>The samples also demonstrate a complex structure of macros showing the power of the Jamal macro processor.
Such complexity is rarely needed.</p>
</div>
<div class="paragraph">
<p>In addition to the technology, I discussed, though only briefly, the separation of concerns for document handling and how the document formatting markup should be separated from the processing meta markup.</p>
</div>
<div class="paragraph">
<p>If you want to have diagrams in your documentation, download Jamal, and start enhancing your documents.</p>
</div>
</div>
</div>


<!-- Disqus comments section goes here (if comments are enabled) -->

<hr/>
<h1>Comments</h1>
<p>Please leave your comments using Disqus, or just press one of the happy faces.
If for any reason you do not want to leave a comment here, <a href="https://github.com/javax0/javax0.github.io/issues">you can still create a Github ticket</a>.</p>
<div class="comments">
    <div id="disqus_thread"></div>

    <script type="text/javascript">

        /* * * STOP! * * */
        /* You shouldn't need to edit ANYTHING below to get this working! */
        /* Instead, edit the key `disqus.shortname` in _config.yml */

        var disqus_config = function (){
            this.page.url = 'https://javax0.github.io/2023/06/05/mermaid-in-jamal.html';
            this.page.identifier = '/2023/06/05/mermaid-in-jamal.html';
        };

        (function() {
            var d = document, s = d.createElement('script');
            s.type = 'text/javascript'; s.async = true;
            s.src = 'https://javax0.disqus.com/embed.js';
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
        })();

    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
</div>




  </div><a class="u-url" href="/2023/06/05/mermaid-in-jamal.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Java Deep, mostly Java</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Java Deep, mostly Java</li><li><a class="u-email" href="mailto:peter@verhas.com">peter@verhas.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/verhas"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">verhas</span></a></li><li><a href="https://www.twitter.com/verhas"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#twitter"></use></svg> <span class="username">verhas</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>javax0 is a technical Java oriented blog. Whenever I find something interesting, in the mood and feel the power to publish it, you will get it here. Publications are usually released on Wednesday 15:00am GMT. Earlier posts of the blog were published on Javax0 Wordpress Site at https://javax0.wordpress.com</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
